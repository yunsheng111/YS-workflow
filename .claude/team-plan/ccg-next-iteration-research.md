# Team Research: CCG 架构下次迭代优化

## 增强后的需求

**[目标]**：
对 CCG 架构优化的遗留问题（P2 优化 + 代理编排重构）进行双模型研究，产出约束集和可执行的后续行动计划。

**[范围]**：
1. P2 优化项：OpenSpec/OPSX 术语统一、ContextWeaver MCP 评估、enhance 工具可靠性改进
2. 代理编排重构：13 个未被 Task 调用的代理清理、命令→代理对齐
3. 长期规划：command manifest 机制、文档自动生成
4. **新发现问题**：占位符替换机制缺失（{{CCG_BIN}} 和 {{WORKDIR}} 不会自动替换）

**[技术约束]**：
- 必须基于当前架构现状（v1.7.61，26 命令，20 代理）
- 不破坏现有命令的执行逻辑
- 保持向后兼容（用户已有的命令调用不受影响）

**[验收标准]**：
- 产出约束集文件：`.claude/team-plan/ccg-next-iteration-research.md`
- 每个遗留问题都有对应的硬约束或软约束
- 每个后续建议都有可验证的成功判据
- 识别实施顺序的依赖关系

---

## 约束集

### 硬约束

- **[HC-1] 占位符替换机制缺失** — 来源：Codex + 实测
  - 描述：`{{CCG_BIN}}` 和 `{{WORKDIR}}` 在命令模板中定义，但在 Bash 执行时不会自动替换
  - 影响范围：14 个使用 `{{CCG_BIN}}` 的命令文件，21 个使用 `{{WORKDIR}}` 的命令文件
  - 实测证据：本次 team-research 调用时 `{{CCG_BIN}}` 导致 "command not found"
  - 违反后果：外部模型命令全部不可执行

- **[HC-2] 命令-代理映射不一致** — 来源：Codex
  - 描述：架构文档声明 "Task 调用 12 个"，但实测只有 7 个代理被 Task 真正调用
  - 影响范围：ARCHITECTURE.md、ARCHITECTURE-VISUAL.md、20 个代理文件
  - 具体偏差：plan/execute/frontend/backend/feat/analyze 标记为 "Task 调用"，但实际是外部模型调用
  - 违反后果：维护者按错误心智模型修改系统，导致架构进一步漂移

- **[HC-3] init-project vs init 命名冲突** — 来源：Codex
  - 描述：config.toml 中为 "init-project"，命令文件名为 "init.md"，文档中为 "ccg:init"
  - 影响范围：.ccg/config.toml、commands/ccg/init.md、ARCHITECTURE.md
  - 违反后果：命令路由失败或配置不一致

- **[HC-4] 硬编码路径残留** — 来源：Codex
  - 描述：命令文件中仍有大量 `C:/Users/Administrator/.claude/.ccg/prompts/...` 绝对路径（ROLE_FILE 路径）
  - 影响范围：26 个命令文件中的 ROLE_FILE 路径
  - 违反后果：跨平台、跨用户迁移失败

- **[HC-5] 主代理必须实现占位符渲染逻辑** — 来源：用户决策（Q1-A）
  - 描述：在调用 Bash 工具前，主代理需要将命令模板中的 `{{CCG_BIN}}` 替换为实际路径，`{{WORKDIR}}` 替换为当前工作目录
  - 影响范围：主代理的命令构建逻辑（CLAUDE.md 或命令执行流程）
  - 违反后果：14 个外部模型命令不可执行

- **[HC-6] 6 个命令必须改为 Task 调用代理** — 来源：用户决策（Q2-B）
  - 描述：plan/execute/frontend/backend/feat/analyze 命令改为使用 `Task(subagent_type="xxx")` 启动子代理
  - 影响范围：6 个命令文件 + 6 个代理文件
  - 违反后果：架构文档与实际执行方式不一致

- **[HC-7] init 命名必须统一为 "init"** — 来源：用户决策（Q3-A）
  - 描述：config.toml 中的 "init-project" 改为 "init"
  - 影响范围：.ccg/config.toml 的 workflows.installed 列表
  - 违反后果：命令路由失败

- **[HC-8] 13 个未被调用的代理必须迁移接入** — 来源：用户决策（Q4-B）
  - 描述：识别哪些命令应该调用这些代理，修改命令改为 Task 调用
  - 影响范围：约 13 个代理文件 + 对应的命令文件
  - 违反后果：代理资源浪费，维护成本高

### 软约束

- **[SC-1] enhance 工具可靠性低** — 来源：本次实测
  - 描述：`mcp______enhance` 频繁失败（本次 workflow 两次失败）
  - 影响范围：所有依赖 enhance 的命令（workflow、team-research 等）
  - 偏离影响：降级到 Claude 自增强，用户体验下降，增强质量不稳定

- **[SC-2] 降级反馈不透明** — 来源：本次实测
  - 描述：降级时未按 CLAUDE.md 规范标注"当前增强模式"和"降级原因"
  - 影响范围：CLAUDE.md 第 1 节和第 7 节的降级规范
  - 偏离影响：用户不知道为什么失败，无法判断是否需要修复配置

- **[SC-3] 文档手工维护易漂移** — 来源：Codex
  - 描述：ARCHITECTURE.md 需要手工同步命令数量、映射表、执行方式
  - 影响范围：ARCHITECTURE.md、ARCHITECTURE-VISUAL.md
  - 偏离影响：文档与实际不一致（已发生：22→26 命令数量漂移）

### 依赖关系

- **[DEP-1] 占位符修复 → 命令可执行性验证**
  - 描述：必须先修复 HC-5（实现渲染层），才能验证 14 个外部模型命令是否正常工作
  - 方向性：HC-5 修复 → 命令执行测试

- **[DEP-2] 命令-代理映射修正 → 代理清理**
  - 描述：必须先修正 HC-6（6 个命令改为 Task 调用），才能安全识别剩余未被调用的代理
  - 方向性：HC-6 修正 → HC-8 代理迁移

- **[DEP-3] 术语统一 → 文档更新**
  - 描述：OpenSpec/OPSX 术语统一后，需要同步更新所有文档和命令文件
  - 方向性：术语决策 → 批量文档更新
  - 状态：暂不实施（留待后续迭代）

- **[DEP-4] 渲染层 → 命令重构**
  - 描述：代理内部调用外部模型时也需要使用占位符，必须先实现渲染层
  - 方向性：HC-5（渲染层）→ HC-6（命令重构）

- **[DEP-5] 6 个代理迁移 → 剩余代理迁移**
  - 描述：HC-6 处理了 6 个代理，HC-8 处理剩余的代理，避免重复工作
  - 方向性：HC-6（6 个代理迁移）→ HC-8（剩余代理迁移）

### 风险

- **[RISK-1] 占位符修复方案选择风险** — 缓解：PoC 验证
  - 描述：方案 A（新增渲染层）vs 方案 B（移除占位符改回显式路径）
  - 缓解策略：先用 1-2 个命令做 PoC，验证渲染层的可行性和性能影响

- **[RISK-2] 代理重构影响面大** — 缓解：分阶段迁移
  - 描述：13 个未被调用的代理可能有隐式依赖（文档、手工调用）
  - 缓解策略：先标记 deprecated，观察 2 周，确认无引用后再删除

- **[RISK-3] 架构文档与实际不一致的治理风险** — 缓解：自动化校验
  - 描述：手工维护文档容易漂移，后续维护者会按错误心智模型修改
  - 缓解策略：建立架构体检脚本，每次升级自动校验命令数量、映射完整性

---

## 成功判据

每条判据必须满足：可观测、可自动化验证、无主观评价。

| 编号 | 类型 | 判据描述 | 验证方式 | 关联约束 |
|------|------|----------|----------|----------|
| OK-1 | 功能 | 所有使用 {{CCG_BIN}} 的命令可正常执行 | 执行 `ccg:workflow` 等命令，无 "command not found" 错误 | HC-1, HC-5 |
| OK-2 | 功能 | 所有使用 {{WORKDIR}} 的命令可正常执行 | 执行外部模型命令，无 "os error 2" 错误 | HC-1, HC-5 |
| OK-3 | 兼容 | 命令-代理映射表与实际执行方式一致 | 自动化脚本校验：扫描命令文件中的 Task 调用，与 ARCHITECTURE.md 映射表对比 | HC-2, HC-6 |
| OK-4 | 功能 | init 命令命名统一 | config.toml、命令文件名、文档三处一致（全部为 "init"） | HC-3, HC-7 |
| OK-5 | 兼容 | ROLE_FILE 路径可跨平台 | 命令文件中无 `C:/Users/...` 绝对路径，使用 `~/.claude/` 或相对路径 | HC-4 |
| OK-6 | 性能 | enhance 工具成功率 ≥ 80% | 统计 10 次 enhance 调用，成功次数 ≥ 8 | SC-1 |
| OK-7 | 功能 | 降级时显示标准化反馈 | 触发 enhance 降级，zhi 消息包含"当前增强模式"和"降级原因" | SC-2 |
| OK-8 | 回归 | 现有命令执行不受影响 | 执行 26 个命令的冒烟测试，全部通过 | - |
| OK-9 | 功能 | 6 个命令改为 Task 调用后功能正常 | 执行 plan/execute/frontend/backend/feat/analyze 命令，验证输出质量与原外部模型调用一致 | HC-6 |
| OK-10 | 功能 | 代理内部可正常调用外部模型 | 代理内部使用占位符调用 codeagent-wrapper，无路径错误 | HC-5, HC-6 |
| OK-11 | 兼容 | 所有代理都被至少一个命令调用 | 自动化脚本扫描：每个代理文件都能在命令文件中找到对应的 Task 调用 | HC-8 |
| OK-12 | 功能 | 架构文档自动校验通过 | 运行架构体检脚本，验证命令数量、映射完整性、路径规范 | RISK-3 |

---

## 开放问题（已解决）

### Q1: 占位符修复方案选择 ✅
**决策**：选项 A - 新增统一渲染层

**用户选择**：主代理在构建 Bash 命令时自动替换占位符

**转化为约束**：
- **[HC-5] 主代理必须实现占位符渲染逻辑** — 来源：用户决策
  - 描述：在调用 Bash 工具前，主代理需要将命令模板中的 `{{CCG_BIN}}` 替换为实际路径，`{{WORKDIR}}` 替换为当前工作目录
  - 影响范围：主代理的命令构建逻辑（可能在 CLAUDE.md 或命令执行流程中实现）
  - 实施要求：14 个使用 `{{CCG_BIN}}` 的命令、21 个使用 `{{WORKDIR}}` 的命令都需要通过渲染层处理

### Q2: 命令-代理映射目标架构 ✅
**决策**：选项 B - 修改命令，改为 Task 调用代理

**用户选择**：6 个命令（plan/execute/frontend/backend/feat/analyze）改为 Task 调用代理，代理内部再调外部模型

**转化为约束**：
- **[HC-6] 6 个命令必须改为 Task 调用代理** — 来源：用户决策
  - 描述：plan/execute/frontend/backend/feat/analyze 命令改为使用 `Task(subagent_type="xxx")` 启动子代理
  - 影响范围：6 个命令文件 + 6 个代理文件（planner、execute-agent、frontend-agent、backend-agent、fullstack-light-agent、analyze-agent）
  - 实施要求：代理内部需要封装外部模型调用逻辑（codeagent-wrapper），保持原有的分析能力

- **[DEP-4] HC-6 依赖 HC-5** — 来源：技术依赖
  - 描述：代理内部调用外部模型时也需要使用占位符，必须先实现渲染层
  - 方向性：HC-5（渲染层）→ HC-6（命令重构）

### Q3: init 命名统一 ✅
**决策**：选项 A - 统一为 "init"

**用户选择**：全部改为 "init"（简洁，与命令文件名一致）

**转化为约束**：
- **[HC-7] init 命名必须统一为 "init"** — 来源：用户决策
  - 描述：config.toml 中的 "init-project" 改为 "init"
  - 影响范围：.ccg/config.toml 的 workflows.installed 列表
  - 实施要求：确保命令路由正常工作（`/ccg:init` 能正确找到 `commands/ccg/init.md`）

### Q4: 未被调用代理的处理策略 ✅
**决策**：选项 B - 立即迁移接入

**用户选择**：修改命令，改为 Task 调用这些代理

**转化为约束**：
- **[HC-8] 13 个未被调用的代理必须迁移接入** — 来源：用户决策
  - 描述：识别哪些命令应该调用这 13 个代理，修改命令改为 Task 调用
  - 影响范围：约 13 个代理文件 + 对应的命令文件
  - 实施要求：与 HC-6 协同处理（部分代理已在 HC-6 中处理）
  - 注意：需要先识别哪些代理是真正"未被调用"的（排除 HC-6 中的 6 个代理）

- **[DEP-5] HC-8 依赖 HC-6** — 来源：技术依赖
  - 描述：HC-6 处理了 6 个代理，HC-8 处理剩余的代理，避免重复工作
  - 方向性：HC-6（6 个代理迁移）→ HC-8（剩余代理迁移）

### Q5: OpenSpec/OPSX 术语统一策略
**状态**：暂不决策，留待后续迭代

**原因**：Q1-Q4 已经产生足够的工作量，术语统一属于 P2 优化项，不影响核心功能

---

## Codex 探索摘要

**模块名称**：架构一致性与代理编排

**关键发现**：
1. 实测命令执行方式为：外部模型 14、Task 6、直接执行 5、Agent Teams 1（与架构文档宣称的 12/8/5/1 不一致）
2. Task 真正调用的代理仅 7 个：get-current-datetime、init-architect、spec-init-agent、spec-research-agent、spec-plan-agent、spec-impl-agent、spec-review-agent
3. 占位符分布：`{{CCG_BIN}}` 出现在 14 个命令，`{{WORKDIR}}` 出现在 21 个命令
4. 当前环境不存在任何可见的占位符渲染器/预处理器
5. `bash -lc "{{CCG_BIN}} --help"` 直接报 `command not found`

**建议的实施阶段**：
- 阶段 1（快速止血）：建立统一占位符解析层或移除占位符运行时依赖
- 阶段 2（一致性修复）：命令执行分类与架构文档一致
- 阶段 3（代理编排重构）：明确 6 个漂移命令的最终路由
- 阶段 4（代理生命周期治理）：对约 13 个未实调代理给出状态
- 阶段 5（可观测保障）：新增架构体检并纳入每次升级验收

**SESSION_ID**: 019c530e-d327-70b2-a6b1-5facd84c61df

---

## Gemini 探索摘要

**模块名称**：工具可靠性与文档体验

**状态**：任务已完成，但输出文件未找到（可能是临时文件清理问题）

**基于本次实测的关键发现**：
1. `mcp______enhance` 两次调用失败，最终使用 Claude 自增强
2. 降级反馈规范已添加到 CLAUDE.md，但实际执行中未触发（因为直接失败）
3. 当前文档维护：手工更新 ARCHITECTURE.md + ARCHITECTURE-VISUAL.md，容易漂移

---

## 后续行动建议

基于用户决策（Q1-A, Q2-B, Q3-A, Q4-B），实施顺序如下：

### 立即可做（下次会话 - 阶段 1）

**优先级 P0 - 快速止血**

1. **实现占位符渲染层（HC-5）**
   - 在主代理的命令构建逻辑中实现占位符替换
   - 替换规则：
     - `{{CCG_BIN}}` → `C:/Users/Administrator/.claude/bin/codeagent-wrapper.exe`（或从配置读取）
     - `{{WORKDIR}}` → 当前工作目录的绝对路径
     - `{{LITE_MODE_FLAG}}` → 根据环境变量生成 `--lite ` 或空字符串
     - `{{GEMINI_MODEL_FLAG}}` → 根据环境变量生成 `--model xxx ` 或空字符串
   - 验证：执行 OK-1 和 OK-2 判据

2. **修正 init 命名冲突（HC-7）**
   - 修改 `.ccg/config.toml`，将 "init-project" 改为 "init"
   - 验证：执行 OK-4 判据

### 中期规划（1-2 周 - 阶段 2-3）

**优先级 P1 - 架构对齐**

3. **重构 6 个命令为 Task 调用（HC-6）**
   - 修改命令文件：plan.md, execute.md, frontend.md, backend.md, feat.md, analyze.md
   - 改为使用 `Task(subagent_type="xxx")` 启动子代理
   - 修改对应的 6 个代理文件，在代理内部封装外部模型调用逻辑
   - 验证：执行 OK-3, OK-9, OK-10 判据

4. **迁移剩余未被调用的代理（HC-8）**
   - 先识别哪些代理是真正"未被调用"的（排除 HC-6 中的 6 个）
   - 分析每个代理的职责，确定应该由哪个命令调用
   - 修改命令文件，改为 Task 调用这些代理
   - 验证：执行 OK-11 判据

5. **更新架构文档（HC-2）**
   - 更新 ARCHITECTURE.md 和 ARCHITECTURE-VISUAL.md
   - 修正命令-代理映射表（反映 HC-6 和 HC-8 的变更）
   - 更新执行方式说明（Task 调用数量变化）
   - 验证：执行 OK-3 判据

### 长期规划（1 个月 - 阶段 4-5）

**优先级 P2 - 体验优化**

6. **清理硬编码路径（HC-4）**
   - 将 ROLE_FILE 路径改为 `~/.claude/.ccg/prompts/...` 或相对路径
   - 验证：执行 OK-5 判据

7. **建立架构体检自动化（RISK-3 缓解）**
   - 编写自动化脚本，校验：
     - 命令数量与 config.toml 一致
     - 映射表完整性（每个命令都有映射）
     - 路径规范（无硬编码绝对路径）
     - 代理调用完整性（每个代理都被至少一个命令调用）
   - 纳入每次升级的验收流程
   - 验证：执行 OK-12 判据

8. **command manifest 机制**
   - 设计 manifest 格式（每命令声明 execution_mode/subagent/vars）
   - 实现文档自动生成（ARCHITECTURE.md 从 manifest 生成）
   - 避免手工维护导致的文档漂移

9. **enhance 工具可靠性改进（SC-1）**
   - 实现断路器模式（连续失败 N 次后自动降级）
   - 实现超时重试（首次失败后重试一次）
   - 改进降级反馈透明化（SC-2）
   - 验证：执行 OK-6 和 OK-7 判据

10. **ContextWeaver MCP 评估**
    - 作为 ace-tool 的免费替代方案
    - PoC 验证：Recall@K、P95 延迟、失败率、token 成本
    - 通过后纳入 fallback 链

### 暂不实施（留待后续迭代）

11. **OpenSpec/OPSX 术语统一**
    - 当前工作量已足够，术语统一属于 P2 优化项
    - 不影响核心功能，可在完成阶段 1-3 后再考虑
