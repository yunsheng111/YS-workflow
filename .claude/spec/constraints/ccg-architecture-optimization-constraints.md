# CCG 架构优化约束集

**生成时间**：2026-02-13
**需求来源**：架构优化 - 任务规划层职责分配与命令层必要性评估
**工作目录**：C:\Users\Administrator\.claude
**约束版本**：v1.0

---

## 约束分类索引

- [硬约束](#硬约束)（技术限制、协议要求）
- [软约束](#软约束)（用户体验、可维护性、扩展性）
- [依赖关系](#依赖关系)（组件间依赖、数据流）
- [风险](#风险)（架构变更风险、降级策略）

---

## 硬约束

### HC-1: 通信拓扑差异（不可违背）

**约束描述**：Subagents 和 Agent Teams 的通信模型在技术层面不可互换。

**技术限制**：
- **Subagents**：严格 Hub-and-Spoke（星型），所有信息必须经主代理中转
- **Agent Teams**：Peer-to-Peer + 广播 + 共享任务列表，支持点对点直连
- **不可跨越**：Subagent 无法直接与其他 Subagent 通信，即使在同一会话中

**影响范围**：
- 任务规划层的职责分配必须考虑通信需求
- 需要实时接口对齐的场景（如前后端联调）必须使用 Agent Teams
- 独立任务可使用 Subagents 降低成本

**验证方式**：
- 检查任务是否需要工作者之间互相通信
- 检查是否需要接口契约实时对齐

---

### HC-2: 进程生命周期模型（不可违背）

**约束描述**：Subagents 和 Agent Teams 的进程模型根本不同，影响状态管理和资源回收。

**技术限制**：
- **Subagents**：短生命周期子进程，request/response 模式，执行完自动退出
- **Agent Teams**：长生命周期独立进程，supervisor + workers 模式，需显式 shutdown + cleanup
- **不可混用**：Subagent 无法保持状态跨多个任务；Teammate 无法自动回收需手动管理

**影响范围**：
- 命令层需明确定义何时使用哪种模式
- 长任务（如 6 阶段工作流）需考虑状态持久化
- 资源清理策略必须区分两种模式

**验证方式**：
- 检查任务是否需要跨步骤状态持久化
- 检查是否需要显式生命周期管理

---

### HC-3: Token 成本差异（不可忽视）

**约束描述**：Agent Teams 的 Token 成本约为 Subagents 的 7 倍。

**技术限制**：
- **Subagents**：结果压缩摘要回传主上下文，主线程膨胀慢
- **Agent Teams**：每个 Teammate 维护完整独立上下文，成本 ≈ `lead + Σ(每个 teammate 完整会话)` + 消息开销
- **官方数据**：Agent Teams plan mode 下约 ~7x 标准会话 token 级别

**影响范围**：
- 简单任务强制使用 Agent Teams 会导致成本浪费
- 需要成本敏感的场景必须优先考虑 Subagents
- 混合策略是成本优化的关键

**验证方式**：
- 评估任务复杂度与协作需求
- 计算预期 Token 消耗

---

### HC-4: 嵌套约束（技术限制）

**约束描述**：Subagents 和 Agent Teams 都有嵌套限制。

**技术限制**：
- **Subagents**：不能再 spawn subagent（防递归）
- **Agent Teams**：不能嵌套 team，单会话同时只管理一个 team
- **不可绕过**：架构设计必须是扁平化的，不能有多层嵌套

**影响范围**：
- 命令层不能设计为递归调用结构
- 复杂任务需要通过阶段划分而非嵌套解决

**验证方式**：
- 检查命令调用链是否存在递归
- 检查是否尝试在 Subagent 内启动 Subagent

---

### HC-5: 权限模型差异（安全约束）

**约束描述**：Subagents 和 Agent Teams 的权限控制粒度不同。

**技术限制**：
- **Subagents**：继承 + 可细粒度限缩（tools/permissionMode）
- **Agent Teams**：继承 Lead 基线，spawn 时不能差异化，运行后可调
- **安全影响**：高安全要求的任务需要使用 Subagents 的细粒度权限控制

**影响范围**：
- 涉及敏感操作的任务规划需考虑权限隔离
- Agent Teams 不适合需要差异化权限的场景

**验证方式**：
- 检查任务是否涉及敏感文件或操作
- 检查是否需要不同工作者有不同权限

---

### HC-6: 用户交互模型（体验约束）

**约束描述**：Subagents 对用户透明，Agent Teams 需用户主动管理。

**技术限制**：
- **Subagents**：自动委派，用户只看最终结果
- **Agent Teams**：需用户 Shift+Up/Down、Split panes 主动管理
- **不可改变**：这是两种模式的设计哲学差异

**影响范围**：
- 命令层需考虑用户的认知负担
- 渐进式披露原则要求优先使用 Subagents
- Agent Teams 适合需要用户介入的复杂场景

**验证方式**：
- 评估用户是否需要实时查看每个工作者进度
- 评估用户是否需要中途干预

---

## 软约束

### SC-1: 渐进式披露原则（设计原则）

**约束描述**：架构应遵循渐进式披露，从简单到复杂逐步暴露能力。

**设计理念**：
- **Level 1**：用户直接与主代理交互（最简单）
- **Level 2**：主代理调用 MCP 工具或 Skills（中等复杂度）
- **Level 3**：主代理通过命令层路由到 Subagents（复杂任务）
- **Level 4**：主代理通过命令层启动 Agent Teams（高复杂度 + 协作需求）

**影响范围**：
- 命令层的存在符合渐进式披露原则
- 用户不需要理解 Subagents vs Agent Teams 的差异
- 命令层作为抽象层屏蔽底层复杂性

**优化方向**：
- 保留命令层作为用户友好的入口
- 命令内部智能选择 Subagents 或 Agent Teams
- 提供清晰的命令分类和使用指南

**验证方式**：
- 用户是否能快速理解命令用途
- 用户是否需要理解底层实现细节

---

### SC-2: 任务规划职责分配（架构决策）

**约束描述**：任务规划应由谁负责 - 主代理、Subagents 还是 Agent Teams Lead？

**当前实践**：
- **主代理规划 + Subagents 执行**：`ccg:plan` → `planner` agent → 主代理实施
- **主代理规划 + Agent Teams 执行**：`ccg:team-plan` → 主代理 + 外部模型 → `ccg:team-exec` spawn Builders
- **Subagent 自主规划**：`spec-plan-agent` 内部调用外部模型生成零决策计划

**权衡因素**：
- **主代理规划**：
  - ✅ 保持上下文连续性
  - ✅ 用户可直接参与规划过程
  - ❌ 主代理上下文膨胀
- **Subagent 规划**：
  - ✅ 独立上下文，不污染主线程
  - ✅ 可复用规划逻辑
  - ❌ 规划结果需回传主代理
- **Agent Teams Lead 规划**：
  - ✅ 规划和执行在同一 Team 内，上下文共享
  - ✅ Builders 可实时反馈规划可行性
  - ❌ Token 成本高
  - ❌ 规划阶段不需要 Peer-to-Peer 通信

**推荐策略**：
- **简单任务**：主代理直接规划并执行
- **中等复杂度**：主代理规划 → Subagents 执行
- **高复杂度独立任务**：Subagent 规划 → 主代理实施
- **高复杂度协作任务**：主代理/Subagent 规划 → Agent Teams 执行

**验证方式**：
- 评估规划复杂度
- 评估是否需要执行者参与规划
- 评估 Token 成本预算

---

### SC-3: 命令层存在必要性（架构决策）

**约束描述**：命令层是否必要，还是可以直接由主代理决策？

**命令层的价值**：
1. **用户友好的抽象**：`/ccg:workflow` 比 "启动 fullstack-agent" 更直观
2. **工作流封装**：6 阶段工作流、双模型调用规范等复杂逻辑封装在命令中
3. **降级策略**：命令内定义 Subagent 不可用时的降级方案
4. **版本控制**：命令文件可版本控制、团队共享、跨会话复用
5. **渐进式披露**：用户不需要理解底层 Subagents/Agent Teams 差异

**去除命令层的风险**：
- 主代理需要在每次会话中重新决策路由逻辑
- 用户需要理解何时使用 Subagents 何时使用 Agent Teams
- 工作流逻辑分散在主代理提示词中，难以维护
- 失去版本控制和团队共享能力

**保留命令层的优化方向**：
- 命令内部智能选择执行方式（Subagents/Agent Teams/外部模型）
- 命令提供清晰的参数和使用示例
- 命令支持组合调用（如 `ccg:plan` + `ccg:execute`）

**验证方式**：
- 评估用户是否能快速上手
- 评估工作流逻辑是否易于维护
- 评估是否需要跨会话复用

---

### SC-4: 混合策略优化（成本与质量平衡）

**约束描述**：在不同阶段使用不同模式，平衡成本与质量。

**三阶段混合模型**（已在 CCG 中实践）：
1. **侦察阶段**（Subagents）：低成本并行扫描，产出约束集
2. **突击阶段**（Agent Teams）：高协作并行实施，实时对齐接口
3. **扫尾阶段**（Subagents）：独立验证审查，pass/fail 判定

**当前实践**：
- `ccg:team-research`（Subagents 式）→ `ccg:team-plan`（主代理 + Subagents）→ `ccg:team-exec`（Agent Teams）→ `ccg:team-review`（Subagents 式）

**优化方向**：
- 明确每个命令的阶段定位
- 提供阶段间数据传递的标准格式
- 支持动态升级（Subagent 发现需要协作 → 升级到 Agent Teams）

**验证方式**：
- 评估每个阶段的成本效益
- 评估阶段间数据传递是否顺畅

---

### SC-5: 可维护性与扩展性（长期演进）

**约束描述**：架构设计需考虑长期维护和功能扩展。

**可维护性要求**：
- 命令、代理、提示词分离，职责清晰
- 每个组件有明确的输入输出格式
- 支持版本控制和团队协作

**扩展性要求**：
- 新增命令不影响现有命令
- 新增代理不影响现有代理
- 支持自定义 Subagents 和 Skills

**当前架构优势**：
- 三层架构（命令层、代理层、提示词层）职责分离
- 命令-代理映射表清晰
- 支持自定义组件

**优化方向**：
- 提供命令和代理的模板
- 提供测试框架验证新组件
- 提供文档生成工具

**验证方式**：
- 评估新增功能的开发成本
- 评估现有功能的修改影响范围

---

## 依赖关系

### DEP-1: 命令层 → 代理层

**依赖描述**：命令层依赖代理层提供执行能力。

**依赖类型**：强依赖

**依赖细节**：
- 12 个命令通过 `Task(subagent_type="xxx")` 调用 Subagents
- 1 个命令（`ccg:team-exec`）通过 `TeamCreate` + `spawn` 启动 Agent Teams
- 8 个命令通过 `codeagent-wrapper` 调用外部模型（Codex/Gemini）
- 5 个命令由主代理直接执行

**影响**：
- 代理层变更可能影响命令层
- 代理工具集变更需同步更新命令文档

**缓解措施**：
- 定义稳定的代理接口（输入/输出格式）
- 代理变更时提供向后兼容性

---

### DEP-2: 代理层 → MCP 工具 / Skills

**依赖描述**：代理层依赖 MCP 工具和 Skills 提供能力。

**依赖类型**：强依赖

**依赖细节**：
- 18 个代理使用 `mcp__ace-tool__search_context`（代码检索）
- 18 个代理使用 `mcp______zhi`（用户确认）
- 15 个代理使用 Grok Search（网络搜索）
- 8 个代理使用 Chrome DevTools（浏览器自动化）
- 多个代理使用 Skills（ui-ux-pro-max、database-designer、git-workflow 等）

**影响**：
- MCP 工具不可用时需降级策略
- Skills 不可用时需替代方案

**缓解措施**：
- 全局提示词定义降级策略
- 代理内部实现降级逻辑

---

### DEP-3: Agent Teams → 共享任务列表

**依赖描述**：Agent Teams 依赖共享任务列表进行协作。

**依赖类型**：强依赖

**依赖细节**：
- Teammates 通过 `TaskList` 查看可用任务
- Teammates 通过 `TaskUpdate` 认领和更新任务
- Lead 通过 `TaskCreate` 创建任务

**影响**：
- 任务列表格式变更影响所有 Teammates
- 任务状态同步失败导致协作混乱

**缓解措施**：
- 定义标准任务格式
- 实现任务状态一致性检查

---

### DEP-4: 混合策略 → 阶段间数据传递

**依赖描述**：混合策略依赖阶段间的数据传递机制。

**依赖类型**：强依赖

**依赖细节**：
- Subagent 阶段产出写入文件（如 `.claude/team-plan/*.md`）
- Agent Teams 阶段读取文件作为上下文
- 主代理整合各阶段结果

**影响**：
- 文件格式不一致导致阶段间数据传递失败
- 文件路径变更影响数据读取

**缓解措施**：
- 定义标准文件格式（Markdown + YAML frontmatter）
- 使用约定的文件路径（如 `.claude/spec/`, `.claude/team-plan/`）

---

## 风险

### RISK-1: 去除命令层导致用户认知负担增加

**风险描述**：如果去除命令层，用户需要直接理解 Subagents vs Agent Teams 的差异。

**风险等级**：高

**影响范围**：
- 用户体验下降
- 学习曲线陡峭
- 违反渐进式披露原则

**触发条件**：
- 架构重构决定去除命令层
- 主代理直接决策路由逻辑

**缓解措施**：
- 保留命令层作为用户友好的抽象
- 命令内部封装复杂的路由逻辑
- 提供清晰的命令分类和使用指南

**应急预案**：
- 如果必须去除命令层，提供详细的迁移指南
- 在主代理提示词中提供决策树
- 提供交互式向导帮助用户选择执行方式

---

### RISK-2: 任务规划职责不清导致重复工作

**风险描述**：如果任务规划职责分配不清晰，可能导致主代理和 Subagents/Agent Teams 重复规划。

**风险等级**：中

**影响范围**：
- Token 成本增加
- 规划结果不一致
- 执行效率下降

**触发条件**：
- 主代理和 Subagent 都尝试规划
- Agent Teams Lead 和 Builders 都尝试规划

**缓解措施**：
- 明确每个命令的规划职责
- 在命令文档中说明谁负责规划
- 提供规划结果的标准格式

**应急预案**：
- 如果发现重复规划，优先使用主代理的规划结果
- 记录重复规划的场景，优化命令逻辑

---

### RISK-3: Agent Teams 成本失控

**风险描述**：过度使用 Agent Teams 导致 Token 成本失控。

**风险等级**：高

**影响范围**：
- 运营成本增加
- 用户预算超支
- 影响系统可持续性

**触发条件**：
- 简单任务使用 Agent Teams
- 长时间运行的 Agent Teams 未及时清理
- 过多 Teammates 并行运行

**缓解措施**：
- 在命令文档中明确何时使用 Agent Teams
- 实现成本预估和预警机制
- 强制 Agent Teams 清理流程

**应急预案**：
- 提供成本监控工具
- 支持动态降级到 Subagents
- 提供成本优化建议

---

### RISK-4: 混合策略阶段间数据传递失败

**风险描述**：阶段间数据传递失败导致后续阶段无法执行。

**风险等级**：中

**影响范围**：
- 工作流中断
- 需要手动干预
- 影响用户体验

**触发条件**：
- 文件格式不一致
- 文件路径错误
- 文件权限问题

**缓解措施**：
- 定义标准文件格式和路径
- 实现文件格式验证
- 提供文件读写错误处理

**应急预案**：
- 提供文件格式修复工具
- 支持手动指定文件路径
- 提供详细的错误信息

---

### RISK-5: 嵌套约束被违反导致系统崩溃

**风险描述**：如果尝试在 Subagent 内启动 Subagent 或嵌套 Agent Teams，系统可能崩溃。

**风险等级**：高

**影响范围**：
- 系统不可用
- 数据丢失
- 用户体验极差

**触发条件**：
- 命令设计为递归调用
- Subagent 内部尝试启动 Subagent
- Agent Teams 内部尝试启动新 Team

**缓解措施**：
- 在命令和代理文档中明确禁止嵌套
- 实现嵌套检测和阻止机制
- 提供扁平化设计指南

**应急预案**：
- 检测到嵌套尝试时立即终止
- 提供清晰的错误信息
- 提供替代方案建议

---

## 约束摘要

### 关键决策点

1. **命令层是否保留**：
   - **推荐**：保留命令层，符合渐进式披露原则
   - **理由**：用户友好、工作流封装、降级策略、版本控制

2. **任务规划职责分配**：
   - **推荐**：根据任务复杂度动态分配
   - **简单任务**：主代理规划并执行
   - **中等复杂度**：主代理规划 → Subagents 执行
   - **高复杂度独立任务**：Subagent 规划 → 主代理实施
   - **高复杂度协作任务**：主代理/Subagent 规划 → Agent Teams 执行

3. **Subagents vs Agent Teams 选择**：
   - **Subagents**：独立任务、低耦合、成本敏感
   - **Agent Teams**：需要实时协作、接口对齐、多假设验证

### 量化评估维度

| 维度 | Subagents | Agent Teams | 命令层 |
|------|-----------|-------------|--------|
| **Token 成本** | 1x（基准） | ~7x | 忽略不计 |
| **通信能力** | Hub-and-Spoke | Peer-to-Peer | N/A |
| **用户认知负担** | 低（透明） | 高（需管理） | 低（抽象） |
| **可维护性** | 高（独立上下文） | 中（需清理） | 高（版本控制） |
| **扩展性** | 高（自定义代理） | 中（会话级别） | 高（新增命令） |

### 核心约束优先级

1. **P0（必须遵守）**：
   - HC-1: 通信拓扑差异
   - HC-2: 进程生命周期模型
   - HC-4: 嵌套约束
   - RISK-5: 嵌套约束被违反

2. **P1（强烈推荐）**：
   - HC-3: Token 成本差异
   - SC-1: 渐进式披露原则
   - SC-3: 命令层存在必要性
   - RISK-1: 去除命令层导致用户认知负担增加
   - RISK-3: Agent Teams 成本失控

3. **P2（建议遵守）**：
   - SC-2: 任务规划职责分配
   - SC-4: 混合策略优化
   - SC-5: 可维护性与扩展性
   - RISK-2: 任务规划职责不清
   - RISK-4: 混合策略阶段间数据传递失败

---

## 下一步行动

1. **生成提案**：基于约束集生成具体的架构优化提案
2. **评估方案**：对比不同方案的优劣
3. **制定计划**：生成零决策可执行计划
4. **实施变更**：按计划执行架构优化
5. **验证结果**：验证优化效果和约束合规性

---

**约束集状态**：✅ 完成
**下一步**：生成提案文档
