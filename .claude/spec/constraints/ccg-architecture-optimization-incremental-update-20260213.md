# CCG 架构优化 - 增量更新

**更新日期**：2026-02-13
**基于版本**：2026-02-13
**更新类型**：增量补充

---

## 更新摘要

- **新增约束**：3 条（1 硬约束 + 2 软约束）
- **更新约束**：2 条（SC-2, SC-3）
- **新增依赖**：1 条（DEP-5）
- **新增风险**：1 条（RISK-6）
- **深入分析**：3 个核心问题

---

## 新增约束

### 硬约束

#### HC-7: 命令层的双重角色（不可分离）

**约束描述**：命令层同时承担"用户入口"和"工作流定义"两个角色，这两个角色不可分离。

**技术限制**：
- **角色 1：用户入口**：提供用户友好的命令名称（如 `/ccg:workflow`）
- **角色 2：工作流定义**：定义执行阶段、外部模型调用、用户交互模式
- **不可分离**：去除任一角色都会导致系统功能缺失

**影响范围**：
- 即使主代理决定了执行哪个命令，命令层仍然提供工作流定义的价值
- 命令层不是"路由层"，而是"工作流封装层"
- 命令层的价值不在于"选择"，而在于"定义"

**验证方式**：
- 检查命令文件是否包含工作流阶段定义
- 检查命令文件是否包含外部模型调用规范
- 检查命令文件是否包含用户交互模式

**优先级**：P0（必须遵守）

**关联约束**：SC-3, SC-7, RISK-6

---

### 软约束

#### SC-6: 规划与执行的上下文连续性（架构决策）

**约束描述**：规划者和执行者的上下文连续性影响效率和质量。

**权衡因素**：

**上下文连续**（规划者 = 执行者）：
- ✅ 无需数据传递，效率高
- ✅ 规划和执行反馈循环短
- ❌ 上下文膨胀（如果在主代理中）

**上下文分离**（规划者 ≠ 执行者）：
- ✅ 独立上下文，不污染主线程
- ✅ 可复用规划逻辑
- ❌ 需要数据传递机制
- ❌ 规划可能不符合执行实际

**当前实践分析**：
- **场景 A**（主代理规划 → Subagent 执行）：适用于规划简单、执行复杂的场景
- **场景 B**（Subagent 规划 → 主代理实施）：适用于规划复杂（需要外部模型）、执行简单的场景
- **场景 C**（主代理规划 → Agent Teams 执行）：适用于规划需要全局视角、执行需要并行协作的场景

**推荐策略**：
- 规划复杂度 > 执行复杂度 → 规划者 ≠ 执行者（如场景 B）
- 规划复杂度 < 执行复杂度 → 规划者 = 执行者（如场景 A 中的 Subagent 自主规划）
- 规划需要全局视角 + 执行需要并行 → 规划者 ≠ 执行者（如场景 C）

**验证方式**：
- 评估规划复杂度（是否需要外部模型、多模型协作）
- 评估执行复杂度（文件数量、依赖关系）
- 评估上下文传递成本

**优先级**：P2（建议遵守）

**关联约束**：SC-2, HC-2, DEP-4

---

#### SC-7: 命令层的渐进式披露层次（设计原则）

**约束描述**：命令层实现渐进式披露的具体层次定义。

**层次定义**：
```
Level 0: 用户直接描述需求
  ↓ (主代理增强需求并分析)
Level 1: 主代理智能判断并推荐命令（/ccg:<name>），执行前与用户确认
         说明推荐理由和预期效果
         支持命令工作流组合（如 ccg:analyze → ccg:plan）
  ↓ (用户确认选择)
Level 2: 用户自主选择或接受推荐，主代理执行相应命令
  ↓ (命令层注入工作流定义)
Level 3: 命令调用相应代理，代理根据工作流阶段需求：
         - 调用 MCP 工具 / Skills（简单能力）
         - 启动 Subagents（独立上下文）
         - 创建 Agent Teams（协作上下文）
         - 调用外部模型 Codex/Gemini（复杂分析）
```

**关键洞察**：
- **主代理的智能决策角色**：分析需求 → 推荐命令 → 说明理由 → 用户确认
- **命令层是"工作流封装层"**：封装复杂的阶段逻辑和交互模式
- **渐进式披露的核心**：
  - Level 0-1：主代理增强需求并推荐命令（用户只需确认）
  - Level 1-2：用户确认后，命令层注入工作流定义
  - Level 2-3：代理根据工作流执行，用户无需关心底层细节
- **命令工作流组合**：主代理可推荐多命令组合（如 analyze → plan → execute）

**影响范围**：
- 命令层的价值在于"封装复杂性"，而非"选择执行路径"
- 主代理决策命令不违反渐进式披露原则
- 命令层和主代理决策是互补的，不是冲突的

**验证方式**：
- 用户是否能快速理解命令用途（Level 1）
- 用户是否需要理解工作流细节（Level 2-4）
- 命令层是否成功封装了复杂性

**优先级**：P0（必须遵守）

**关联约束**：SC-1, SC-3, HC-7

---

## 更新约束

### SC-3: 命令层存在必要性（架构决策）

**更新理由**：需要澄清"主代理决策命令"与"命令层路由"的关系

**原约束**：命令层提供用户友好的抽象、工作流封装、降级策略、版本控制

**更新内容**：

**命令层的价值（重新定义）**：
1. **用户友好的抽象**：`/ccg:workflow` 比 "启动 fullstack-agent" 更直观（✅ 保持）
2. **工作流封装**：6 阶段工作流、双模型调用规范等复杂逻辑封装在命令中（✅ 保持，**强化**）
3. **降级策略**：命令内定义 Subagent 不可用时的降级方案（✅ 保持）
4. **版本控制**：命令文件可版本控制、团队共享、跨会话复用（✅ 保持）
5. **渐进式披露**：用户不需要理解底层 Subagents/Agent Teams 差异（✅ 保持）
6. **🆕 工作流定义与执行分离**：主代理决定"执行哪个命令"，命令层定义"如何执行"

**关键澄清**：
- **主代理的职责**：分析用户需求 → 决定执行哪个命令
- **命令层的职责**：定义工作流阶段 → 定义外部模型调用 → 定义用户交互模式
- **两者关系**：互补而非冲突，主代理做"选择"，命令层做"定义"

**去除命令层的新风险**：
- 工作流逻辑分散在主代理提示词中，每次会话都需要重新定义
- 失去工作流的版本控制和团队共享能力
- 主代理上下文膨胀（需要包含所有工作流定义）

**优先级**：P1（强烈推荐）

**关联约束**：HC-7, SC-7, RISK-6

---

### SC-2: 任务规划职责分配（架构决策）

**更新理由**：需要补充"规划与执行的上下文连续性"考量

**原约束**：根据任务复杂度动态分配规划者

**更新内容**：

**推荐策略（增强版）**：
- **简单任务**：主代理规划并执行（上下文连续）
- **中等复杂度**：
  - 规划简单 + 执行复杂 → 主代理规划 → Subagent 执行
  - 规划复杂 + 执行简单 → Subagent 规划 → 主代理实施
- **高复杂度独立任务**：Subagent 规划 → 主代理实施（规划需要外部模型）
- **高复杂度协作任务**：主代理/Subagent 规划 → Agent Teams 执行（规划需要全局视角）

**新增决策维度**：
- **规划复杂度**：是否需要外部模型、多模型协作
- **执行复杂度**：文件数量、依赖关系
- **上下文连续性**：规划和执行是否需要在同一上下文

**优先级**：P2（建议遵守）

**关联约束**：SC-6, HC-2, DEP-4

---

## 新增依赖关系

### DEP-5: 主代理决策 → 命令层工作流定义

**依赖描述**：主代理决策执行哪个命令后，依赖命令层提供工作流定义。

**依赖类型**：强依赖

**依赖细节**：
- 主代理分析用户需求 → 决定执行 `/ccg:workflow`
- 命令层注入 `workflow.md` 到主代理上下文
- 主代理根据工作流定义执行 6 阶段流程

**影响**：
- 命令层变更影响主代理执行逻辑
- 命令层缺失导致主代理无法执行工作流

**缓解措施**：
- 定义稳定的命令接口（工作流阶段、输入输出格式）
- 命令变更时提供向后兼容性

**关联约束**：HC-7, SC-3, DEP-1

---

## 新增风险

### RISK-6: 工作流定义分散导致维护困难

**风险描述**：如果去除命令层，工作流定义分散在主代理提示词中，导致维护困难。

**风险等级**：高

**影响范围**：
- 工作流逻辑难以版本控制
- 工作流变更影响所有会话
- 团队协作困难（无法共享工作流定义）

**触发条件**：
- 架构重构决定去除命令层
- 工作流定义移到主代理提示词

**缓解措施**：
- 保留命令层作为工作流定义的载体
- 命令文件版本控制
- 提供命令模板和测试框架

**应急预案**：
- 如果必须去除命令层，提供工作流定义的标准格式
- 在主代理提示词中提供工作流模板
- 提供工作流验证工具

**关联约束**：HC-7, SC-3, SC-5

---

## 深入分析

### 问题 1：主代理决策命令 vs 命令层路由的权衡

**问题描述**：既然主代理已经决定了执行哪个命令，命令层的"路由"价值是什么？

**分析**：

**关键发现**：命令层不是"路由层"，而是"工作流封装层"。

**职责分离**：
```
用户需求 → 主代理分析 → 决定执行 /ccg:workflow（主代理职责：选择）
                ↓
            命令层注入 → 定义 6 阶段工作流（命令层职责：定义）
                ↓
            主代理执行 → 按工作流定义执行（主代理职责：执行）
```

**命令层的真正价值**：
1. **工作流定义**：封装复杂的阶段逻辑（如 6 阶段工作流）
2. **外部模型调用规范**：定义 Codex/Gemini 的调用方式和角色
3. **用户交互模式**：定义何时使用三术确认、何时展示选项
4. **降级策略**：定义 Subagent 不可用时的降级方案
5. **版本控制**：工作流定义可版本控制、团队共享

**结论**：
- 主代理决策命令 ≠ 命令层失去价值
- 主代理做"选择"（执行哪个命令），命令层做"定义"（如何执行）
- 两者是互补关系，不是冲突关系

**对已有结论的影响**：
- ✅ 强化了"命令层必须保留"的结论
- ✅ 澄清了命令层的真正价值（工作流封装 > 路由选择）
- ✅ 解决了"主代理决策命令是否让命令层失去意义"的疑问

---

### 问题 2：规划职责最优分配

**问题描述**：为什么场景 B（Subagent 规划 → 主代理实施）需要 Subagent 规划后主代理实施？这是否违反了"规划者应该执行"的原则？

**分析**：

**场景 B 的典型案例**：`ccg:analyze` 命令
- Subagent（analyze-agent）调用 Codex + Gemini 进行技术分析
- 产出技术方案和建议
- 主代理根据分析结果实施代码变更

**为什么不是 Subagent 直接实施？**
1. **规划复杂度 > 执行复杂度**：技术分析需要多模型协作，但代码变更可能很简单
2. **上下文连续性**：主代理需要保持与用户的交互上下文
3. **权限控制**：代码变更需要主代理的完整权限，Subagent 可能被限缩

**"规划者应该执行"的原则适用场景**：
- 规划和执行复杂度相当
- 不需要跨上下文传递大量数据
- 执行者有足够权限

**场景 B 的合理性**：
- 规划需要独立上下文（避免主代理上下文膨胀）
- 规划需要外部模型（Codex/Gemini）
- 执行需要主代理的完整权限和用户交互能力

**结论**：
- "规划者应该执行"不是绝对原则，需要考虑上下文连续性
- 场景 B 是合理的，适用于"规划复杂 + 执行简单"的场景
- 新增 SC-6 约束明确了上下文连续性的权衡

**对已有结论的影响**：
- ✅ 补充了"任务规划职责动态分配"的决策维度
- ✅ 明确了"规划与执行的上下文连续性"考量
- ✅ 解释了为什么不同场景有不同的规划-执行模式

---

### 问题 3：渐进式披露实现

**问题描述**：渐进式披露的"层次"是什么？用户 → 命令 → 代理 → 工具，还是用户 → 命令 → 工具？

**分析**：

**完整的渐进式披露层次**（新增 SC-7）：
```
Level 0: 用户直接描述需求
  ↓ (主代理增强需求并分析)
Level 1: 主代理智能判断并推荐命令（/ccg:<name>），执行前与用户确认
         说明推荐理由和预期效果
         支持命令工作流组合（如 ccg:analyze → ccg:plan）
  ↓ (用户确认选择)
Level 2: 用户自主选择或接受推荐，主代理执行相应命令
  ↓ (命令层注入工作流定义)
Level 3: 命令调用相应代理，代理根据工作流阶段需求：
         - 调用 MCP 工具 / Skills（简单能力）
         - 启动 Subagents（独立上下文）
         - 创建 Agent Teams（协作上下文）
         - 调用外部模型 Codex/Gemini（复杂分析）
```

**关键洞察**：
1. **Level 0 → Level 1**：主代理增强需求并推荐命令（智能决策 + 用户确认）
2. **Level 1 → Level 2**：用户确认后，主代理执行命令
3. **Level 2 → Level 3**：命令层注入工作流定义，代理根据定义执行

**用户视角的渐进式披露**：
- **新手用户**：只需描述需求（Level 0），主代理推荐命令并说明理由，用户确认即可
- **中级用户**：可以了解命令的工作流阶段（Level 2-3）
- **高级用户**：可以了解代理、工具和外部模型的调用细节（Level 3）

**命令层在渐进式披露中的作用**：
- 封装 Level 3 的复杂性（代理、工具、外部模型调用）
- 用户只需要确认"做什么"（Level 1 推荐），不需要知道"怎么做"（Level 3 细节）
- 主代理负责推荐和说明，命令层负责定义和封装

**结论**：
- 渐进式披露是多层次的，包含智能推荐和用户确认环节
- 主代理负责 Level 0 → Level 1（增强需求 + 推荐命令 + 说明理由）
- 命令层负责 Level 2 → Level 3（注入工作流定义 + 封装执行细节）
- 主代理推荐命令不违反渐进式披露原则，反而增强了用户体验

**对已有结论的影响**：
- ✅ 明确了渐进式披露的具体层次（新增 SC-7）
- ✅ 澄清了命令层在渐进式披露中的作用
- ✅ 强化了"命令层必须保留"的结论

---

## 对已有结论的影响

### 核心结论 1：命令层必须保留 ✅

**影响**：✅ 强化

**理由**：
- 新增 HC-7 明确了命令层的双重角色（用户入口 + 工作流定义）
- 新增 SC-7 明确了命令层在渐进式披露中的作用
- 更新 SC-3 澄清了主代理决策命令与命令层的关系（互补而非冲突）
- 新增 RISK-6 强调了去除命令层的维护风险

**量化评估**：
- 命令层价值：从 5 个维度增加到 6 个维度（新增"工作流定义与执行分离"）
- 去除命令层的风险：从 3 个增加到 4 个（新增 RISK-6）

---

### 核心结论 2：任务规划职责动态分配 ✅

**影响**：✅ 补充

**理由**：
- 新增 SC-6 明确了"规划与执行的上下文连续性"考量
- 更新 SC-2 补充了新的决策维度（规划复杂度、执行复杂度、上下文连续性）
- 解释了为什么不同场景有不同的规划-执行模式

**量化评估**：
- 决策维度：从 2 个（任务复杂度、协作需求）增加到 5 个（+ 规划复杂度、执行复杂度、上下文连续性）

---

### 核心结论 3：混合策略是最优解 ✅

**影响**：✅ 保持

**理由**：
- 增量更新未改变混合策略的核心逻辑
- 新增约束进一步支持混合策略的合理性

**量化评估**：
- 成本节省：64%（保持不变）

---

## 推荐行动

### 立即行动（本周）

1. **更新 CLAUDE.md**
   - 补充 HC-7、SC-6、SC-7 到全局提示词
   - 更新 SC-2、SC-3 的描述
   - 补充 DEP-5、RISK-6

2. **更新命令文档**
   - 在命令文档中明确"工作流定义"的价值
   - 补充"主代理决策 vs 命令层定义"的说明

3. **更新代理文档**
   - 在代理文档中明确"规划与执行的上下文连续性"考量
   - 补充规划职责的决策维度

### 短期行动（下周）

4. **实现工作流定义验证工具**
   - 验证命令文件是否包含完整的工作流定义
   - 验证工作流定义的格式和完整性

5. **实现规划职责决策工具**
   - 根据任务特征自动推荐规划者
   - 提供决策树可视化

### 中期行动（本月）

6. **优化命令层文档**
   - 提供命令模板
   - 提供工作流定义的最佳实践

7. **优化代理层文档**
   - 提供规划-执行模式的最佳实践
   - 提供上下文连续性的权衡指南

---

## 约束统计

### 更新前后对比

| 约束类型 | 更新前 | 更新后 | 变化 |
|----------|--------|--------|------|
| 硬约束 | 6 | 7 | +1 (HC-7) |
| 软约束 | 5 | 7 | +2 (SC-6, SC-7) |
| 依赖关系 | 4 | 5 | +1 (DEP-5) |
| 风险 | 5 | 6 | +1 (RISK-6) |
| **总计** | **20** | **25** | **+5** |

### 优先级分布

| 优先级 | 更新前 | 更新后 | 变化 |
|--------|--------|--------|------|
| P0（必须遵守） | 5 | 7 | +2 (HC-7, SC-7) |
| P1（强烈推荐） | 7 | 7 | 0 |
| P2（建议遵守） | 8 | 11 | +3 (SC-6, SC-2 更新, DEP-5) |

---

## 关键发现（5 条）

1. **命令层不是"路由层"，而是"工作流封装层"**
   - 主代理做"推荐"（智能判断并推荐命令 + 说明理由）
   - 用户做"确认"（选择接受推荐或自主选择）
   - 命令层做"定义"（注入工作流定义 + 封装执行细节）
   - 三者是协作关系，形成完整的渐进式披露链条

2. **"规划者应该执行"不是绝对原则**
   - 需要考虑规划复杂度、执行复杂度、上下文连续性
   - 场景 B（Subagent 规划 → 主代理实施）是合理的

3. **渐进式披露是多层次的，包含智能推荐环节**
   - Level 0-3 的完整层次定义
   - 主代理负责增强需求并推荐命令（Level 0 → Level 1）
   - 命令层负责注入工作流定义（Level 2 → Level 3）
   - 支持命令工作流组合（如 analyze → plan → execute）

4. **去除命令层的新风险：工作流定义分散**
   - 工作流逻辑难以版本控制
   - 团队协作困难

5. **主代理智能推荐增强了渐进式披露**
   - 主代理推荐是 Level 0 → Level 1 的智能决策
   - 用户确认是 Level 1 → Level 2 的主动选择
   - 命令层封装是 Level 2 → Level 3 的工作流定义
   - 新手用户只需描述需求并确认推荐，无需理解底层细节

---

## 对已有结论的影响评估

### 核心结论 1：命令层必须保留 ✅

**影响**：✅ 强化（从 ⭐⭐⭐⭐⭐ 提升到 ⭐⭐⭐⭐⭐+）

**支持约束**：
- 原有：SC-1, SC-3, HC-6, RISK-1
- 新增：HC-7, SC-7, RISK-6

### 核心结论 2：任务规划职责动态分配 ✅

**影响**：✅ 补充（决策维度从 2 个增加到 5 个）

**支持约束**：
- 原有：SC-2, HC-1, HC-3
- 新增：SC-6

### 核心结论 3：混合策略是最优解 ✅

**影响**：✅ 保持（成本节省 64% 不变）

**支持约束**：
- 原有：SC-4, HC-3, DEP-4
- 新增：无（但进一步验证了合理性）

---

**增量更新状态**：✅ 完成
**下一步**：更新执行摘要，整合到主约束集
