# CCG 成本优化指南

本指南帮助您理解如何降低 Token 成本，优化 CCG 命令的使用效率。

---

## 成本模型

CCG 的成本主要来自以下几个方面：

1. **主代理执行**：基准成本（1x）
2. **Subagent 调用**：每个 Subagent 独立上下文（1x）
3. **外部模型调用**：Codex/Gemini 分析（计入 Subagent 成本）
4. **Agent Teams**：多个 Builder 并行执行（7x）

---

## 成本优化策略

### 策略 1：选择合适的命令

不同命令的成本差异很大，选择合适的命令是最有效的优化方式。

| 命令类型 | 成本倍数 | 何时使用 |
|----------|----------|----------|
| commit, enhance, rollback | 1x | 简单的 Git 操作、Prompt 增强 |
| feat, frontend, backend | 1x | 单模块功能开发 |
| workflow | 2-3x | 多模块全栈开发 |
| team-exec | 7x | 大规模并行开发 |

**优化建议**：
- 优先使用成本较低的命令
- 只有在必要时才升级到高成本命令
- 避免过度使用 Agent Teams

---

### 策略 2：拆分大任务

将大任务拆分为多个小任务，可以显著降低成本。

**示例**：

❌ **不推荐**（成本 7x）：
```bash
/ccg:team-exec 重构整个系统，包含前端、后端、数据库
```

✅ **推荐**（成本 3x）：
```bash
/ccg:backend 重构后端 API
/ccg:frontend 重构前端组件
/ccg:feat 更新数据库迁移脚本
```

**成本节省**：7x → 3x（节省 57%）

---

### 策略 3：使用混合策略

对于复杂任务，使用混合策略（workflow）而不是纯 Agent Teams。

**对比**：

| 方案 | 成本 | 说明 |
|------|------|------|
| 纯 Agent Teams（4 阶段） | 28x | 每个阶段 7x |
| 混合策略（workflow） | 2-3x | 侦察（Subagents）→ 实施（主代理）→ 审查（Subagents） |

**成本节省**：28x → 2.5x（节省 91%）

**何时使用混合策略？**
- 任务涉及多个阶段（研究、规划、实施、审查）
- 阶段之间无需实时协作
- 文件数量 < 8 个

---

### 策略 4：避免重复调用

合理规划任务，避免重复调用相同的命令。

**示例**：

❌ **不推荐**（成本 3x）：
```bash
/ccg:analyze 分析用户模块
/ccg:analyze 分析订单模块
/ccg:analyze 分析支付模块
```

✅ **推荐**（成本 1x）：
```bash
/ccg:analyze 分析用户、订单、支付三个模块的技术方案
```

**成本节省**：3x → 1x（节省 67%）

---

### 策略 5：利用缓存和复用

CCG 会自动缓存一些结果，合理利用可以减少重复计算。

**示例**：

1. **复用计划文件**：
   ```bash
   /ccg:plan 开发用户管理模块
   # 计划保存到 .claude/plan/user-management.md

   /ccg:execute  # 直接使用已有计划，无需重新规划
   ```

2. **复用研究结果**：
   ```bash
   /ccg:team-research 重构认证系统
   # 约束集保存到 .claude/team-plan/auth-refactor-research.md

   /ccg:team-plan  # 直接使用已有约束集
   ```

---

### 策略 6：控制 Agent Teams 使用

Agent Teams 成本最高（7x），只在必要时使用。

**何时使用 Agent Teams？**
- ✅ 文件数量 > 8 个
- ✅ 需要前后端并行开发
- ✅ 需要接口契约实时对齐
- ✅ 预算充足

**何时不使用 Agent Teams？**
- ❌ 文件数量 < 5 个
- ❌ 任务可以串行执行
- ❌ 预算有限

**替代方案**：
- 使用 `/ccg:workflow`（混合策略，2-3x）
- 使用 `/ccg:feat`（Subagent，1x）
- 拆分为多个独立任务

---

## 成本失控的常见原因

### 原因 1：过度使用 Agent Teams

**问题**：对所有任务都使用 Agent Teams

**解决方案**：
- 评估任务是否真的需要实时协作
- 优先使用混合策略或 Subagents
- 只在必要时使用 Agent Teams

---

### 原因 2：任务粒度过大

**问题**：一次性处理过多功能

**解决方案**：
- 将大任务拆分为多个小任务
- 每个任务专注于单一功能
- 逐步迭代，而不是一次性完成

---

### 原因 3：重复调用相同命令

**问题**：对相似任务重复调用

**解决方案**：
- 合并相似任务
- 复用已有的计划和研究结果
- 使用批量处理

---

### 原因 4：忽略成本预估

**问题**：执行前不查看成本预估

**解决方案**：
- 执行前查看成本预估
- 评估成本是否合理
- 考虑使用更轻量的命令

---

## 成本优化案例

### 案例 1：用户管理模块开发

**需求**：开发用户列表、详情、编辑三个页面

**方案对比**：

| 方案 | 命令 | 成本 | 说明 |
|------|------|------|------|
| 方案 A | `/ccg:team-exec` | 7x | 过度使用 Agent Teams |
| 方案 B | `/ccg:workflow` | 2-3x | 混合策略，推荐 |
| 方案 C | `/ccg:feat` × 3 | 3x | 拆分为三个独立任务 |

**推荐**：方案 B（workflow），成本适中，功能完整。

---

### 案例 2：代码审查

**需求**：审查最近的代码变更

**方案对比**：

| 方案 | 命令 | 成本 | 说明 |
|------|------|------|------|
| 方案 A | `/ccg:team-review` | 1x | 双模型交叉审查 |
| 方案 B | `/ccg:review` | 1x | 多维度审查 |

**推荐**：方案 B（review），成本相同，但更简单。

---

### 案例 3：性能优化

**需求**：优化数据库查询、前端渲染、API 响应

**方案对比**：

| 方案 | 命令 | 成本 | 说明 |
|------|------|------|------|
| 方案 A | `/ccg:optimize` × 3 | 3x | 分别优化三个方面 |
| 方案 B | `/ccg:optimize` | 1x | 一次性优化所有方面 |

**推荐**：方案 B，成本节省 67%。

---

## 成本监控

### 查看成本预估

执行命令前，CCG 会显示成本预估：

```bash
/ccg:workflow 开发用户管理模块
```

输出：
```
📊 成本预估：/workflow
执行模式：混合策略
复杂度：高
协作需求：高

预估 Token 成本：2,500 tokens (2-3x)
基准成本：1,000 tokens

💡 混合策略模式，在不同阶段使用不同工具，成本适中
```

### 成本预估工具

使用成本预估工具查看命令成本：

```bash
node .ccg/runtime/cost-estimator.cjs workflow 1000
```

输出：
```
📊 成本预估：/workflow

执行模式：混合策略
复杂度：高
协作需求：高

预估 Token 成本：2,500 tokens (2-3x)
基准成本：1,000 tokens

💡 混合策略模式，在不同阶段使用不同工具，成本适中

详细信息：
  成本倍数：2.5x
  文件数量阈值：5
  需要实时对齐：否
```

---

## 最佳实践总结

1. **选择合适的命令**：优先使用成本较低的命令
2. **拆分大任务**：将大任务拆分为多个小任务
3. **使用混合策略**：对于复杂任务，使用 workflow 而不是 team-exec
4. **避免重复调用**：合并相似任务，复用已有结果
5. **利用缓存**：复用计划文件和研究结果
6. **控制 Agent Teams**：只在必要时使用
7. **查看成本预估**：执行前评估成本是否合理
8. **监控成本**：定期检查成本使用情况

---

## 相关文档

- [智能路由用户指南](./user-guide-routing.md) - 如何选择合适的命令
- [架构文档](../.ccg/ARCHITECTURE.md) - 智能路由章节
- [命令参考](../commands/ccg/) - 所有命令的详细说明

---

**版本**：v1.0
**更新时间**：2026-02-13
**适用于**：CCG 架构优化后的版本
