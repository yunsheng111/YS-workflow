# CCG 架构优化提案

**生成时间**：2026-02-13
**约束集来源**：ccg-architecture-optimization-constraints.md
**提案版本**：v1.0

---

## 执行摘要

基于对 CCG 架构的深度分析和约束集识别，本提案提出**保留并优化命令层**的架构方案，通过**智能路由 + 混合策略**实现任务规划层的职责优化，在保持用户友好性的同时最大化系统效率。

### 核心结论

1. **命令层必须保留**：符合渐进式披露原则，提供用户友好的抽象层
2. **任务规划职责动态分配**：根据任务复杂度和协作需求智能选择规划者
3. **混合策略是最优解**：在不同阶段使用不同模式，平衡成本与质量

---

## 提案 A：保留并优化命令层（推荐方案）

### 方案概述

保留现有的三层架构（命令层、代理层、提示词层），通过以下优化提升系统效率：

1. **命令层智能路由**：命令内部根据任务特征自动选择执行方式
2. **任务规划职责矩阵**：明确不同场景下的规划职责分配
3. **混合策略标准化**：定义阶段间数据传递的标准格式

### 架构设计

```
用户
  │
  ├─ /ccg:<name> 命令（入口层）
  │   │
  │   ├─ 智能路由决策
  │   │   ├─ 任务复杂度评估
  │   │   ├─ 协作需求分析
  │   │   └─ 成本预算考量
  │   │
  │   └─ 执行路径选择
  │       ├─ Route 1: 主代理直接执行（简单任务）
  │       ├─ Route 2: Subagents 执行（中等复杂度）
  │       ├─ Route 3: Agent Teams 执行（高协作需求）
  │       └─ Route 4: 混合策略（侦察-突击-扫尾）
  │
  ├─ 代理层（执行层）
  │   ├─ Subagents（独立上下文）
  │   └─ Agent Teams（协作上下文）
  │
  └─ 提示词层（外部模型）
      ├─ Codex（后端逻辑）
      └─ Gemini（前端交互）
```

### 任务规划职责矩阵

| 任务类型 | 复杂度 | 协作需求 | 规划者 | 执行者 | 示例命令 |
|----------|--------|----------|--------|--------|----------|
| 简单查询 | 低 | 无 | 主代理 | 主代理 | `ccg:enhance` |
| 单模块功能 | 中 | 无 | 主代理 | Subagent | `ccg:plan` → `ccg:execute` |
| 复杂分析 | 高 | 无 | Subagent | 主代理 | `ccg:analyze` |
| 前后端联调 | 高 | 高 | 主代理/Subagent | Agent Teams | `ccg:team-plan` → `ccg:team-exec` |
| 多模块重构 | 高 | 高 | 混合（侦察-规划-突击） | 混合 | `ccg:workflow` |

### 智能路由决策树

```
任务输入
  │
  ├─ 是否需要代码变更？
  │   ├─ 否 → 主代理直接执行（如 ccg:enhance）
  │   └─ 是 ↓
  │
  ├─ 涉及多少个文件？
  │   ├─ 1-3 个 → 主代理或 Subagent 执行
  │   └─ 4+ 个 ↓
  │
  ├─ 文件间是否需要接口对齐？
  │   ├─ 否 → Subagents 并行执行
  │   └─ 是 ↓
  │
  ├─ 是否需要实时协商？
  │   ├─ 否 → 主代理规划 → Subagents 执行
  │   └─ 是 → 混合策略（侦察-突击-扫尾）
  │
  └─ Token 预算是否充足？
      ├─ 是 → Agent Teams 执行
      └─ 否 → 降级到 Subagents + 主代理协调
```

### 混合策略标准化

#### 阶段定义

| 阶段 | 模式 | 职责 | 输出格式 | 存储路径 |
|------|------|------|----------|----------|
| **侦察** | Subagents | 代码扫描、依赖分析、约束识别 | Markdown + YAML | `.claude/spec/constraints/` |
| **规划** | 主代理/Subagent | 任务分解、依赖标注、零决策化 | Markdown + YAML | `.claude/spec/plans/` 或 `.claude/team-plan/` |
| **突击** | Agent Teams | 并行实施、实时对齐、接口协商 | 代码变更 | 项目源代码 |
| **扫尾** | Subagents | 集成测试、安全审计、性能检查 | Markdown 报告 | `.claude/spec/reviews/` |

#### 数据传递标准

**约束集格式**（侦察阶段输出）：
```yaml
---
version: v1.0
timestamp: 2026-02-13T10:00:00Z
task: "任务描述"
---

# 约束集标题

## 硬约束
- HC-1: 约束描述

## 软约束
- SC-1: 约束描述

## 依赖关系
- DEP-1: 依赖描述

## 风险
- RISK-1: 风险描述
```

**计划格式**（规划阶段输出）：
```yaml
---
version: v1.0
timestamp: 2026-02-13T11:00:00Z
constraints_file: ".claude/spec/constraints/xxx.md"
---

# 实施计划标题

## 子任务列表

### 子任务 1
- **文件范围**: [file1.ts, file2.ts]
- **操作类型**: 新增/修改/删除
- **实施步骤**: [步骤1, 步骤2]
- **验证方式**: 如何确认完成
- **约束映射**: [HC-1, SC-2]
- **依赖**: 无/子任务N
- **并行分组**: Layer 1
```

### 命令层优化清单

#### 新增功能

1. **智能路由元数据**：在每个命令文件中添加路由决策元数据
```yaml
---
routing:
  complexity: low|medium|high
  collaboration: none|low|high
  default_mode: main|subagent|team|hybrid
  cost_estimate: 1x|3x|7x
---
```

2. **成本预估工具**：在命令执行前显示预估 Token 成本
```
📊 成本预估：
- 模式：Agent Teams
- 预估 Token：~7x 标准会话
- 预估时间：15-30 分钟
确认继续？[Y/n]
```

3. **动态降级机制**：Agent Teams 不可用时自动降级到 Subagents
```
⚠️ Agent Teams 未启用，自动降级到 Subagents 模式
- 原计划：并行 spawn 3 个 Builders
- 降级方案：串行执行 3 个 Subagents
- 预估时间增加：+10 分钟
```

#### 优化现有命令

1. **`ccg:workflow`**：明确 6 阶段中哪些阶段使用 Subagents，哪些使用 Agent Teams
2. **`ccg:feat`**：增强智能路由，根据文件数量和依赖关系自动选择模式
3. **`ccg:plan`**：支持输出标准化计划格式，便于后续阶段读取

### 实施步骤

#### Phase 1: 标准化（1-2 天）

1. 定义约束集、计划、报告的标准格式
2. 更新所有命令文档，添加路由元数据
3. 创建数据传递验证工具

#### Phase 2: 智能路由（2-3 天）

1. 在命令层实现智能路由决策逻辑
2. 实现成本预估工具
3. 实现动态降级机制

#### Phase 3: 混合策略（3-5 天）

1. 优化 `ccg:team-*` 命令，标准化阶段间数据传递
2. 实现阶段状态追踪
3. 实现阶段间数据验证

#### Phase 4: 测试与文档（2-3 天）

1. 测试所有命令的智能路由
2. 测试混合策略的阶段间数据传递
3. 更新用户文档和开发者文档

### 优势

1. **用户友好**：保持命令层抽象，用户无需理解底层复杂性
2. **成本优化**：智能路由避免过度使用 Agent Teams
3. **质量保证**：混合策略在关键阶段使用 Agent Teams
4. **可维护性**：标准化格式便于长期维护
5. **可扩展性**：新增命令遵循相同模式

### 劣势

1. **实施复杂度**：需要更新所有命令文档
2. **测试成本**：需要测试所有路由路径
3. **学习曲线**：开发者需要理解智能路由逻辑

---

## 提案 B：去除命令层（不推荐）

### 方案概述

去除命令层，由主代理直接决策是否使用 Subagents 或 Agent Teams。

### 架构设计

```
用户
  │
  ├─ 直接与主代理交互
  │   │
  │   ├─ 主代理分析任务
  │   ├─ 主代理决策路由
  │   └─ 主代理选择执行方式
  │
  ├─ Subagents（独立上下文）
  └─ Agent Teams（协作上下文）
```

### 优势

1. **架构简化**：减少一层抽象
2. **灵活性高**：主代理可根据实时情况动态决策

### 劣势（致命缺陷）

1. **违反渐进式披露原则**：用户需要理解 Subagents vs Agent Teams 差异
2. **用户认知负担增加**：用户需要描述任务特征以帮助主代理决策
3. **工作流逻辑分散**：6 阶段工作流等复杂逻辑分散在主代理提示词中
4. **失去版本控制**：无法版本控制和团队共享工作流
5. **降级策略缺失**：无法预定义降级方案
6. **成本预估困难**：用户无法提前知道成本

### 风险评估

- **RISK-1（高）**：用户认知负担增加，学习曲线陡峭
- **RISK-2（中）**：任务规划职责不清，可能重复规划
- **RISK-3（高）**：无成本预估，可能导致成本失控

### 结论

**不推荐此方案**，劣势远大于优势。

---

## 提案 C：混合方案（折中方案）

### 方案概述

保留命令层作为可选入口，同时增强主代理的直接决策能力。

### 架构设计

```
用户
  │
  ├─ 路径 1: /ccg:<name> 命令（推荐）
  │   └─ 命令层智能路由
  │
  └─ 路径 2: 直接描述任务
      └─ 主代理分析并决策
```

### 优势

1. **灵活性**：用户可选择使用命令或直接描述
2. **渐进式披露**：新手使用命令，高级用户直接描述

### 劣势

1. **维护成本高**：需要维护两套路由逻辑
2. **一致性风险**：命令路由和主代理决策可能不一致
3. **用户困惑**：两种方式可能导致用户不知道选哪个

### 结论

**可作为长期演进方向**，但短期内不推荐，维护成本过高。

---

## 方案对比

| 维度 | 提案 A（推荐） | 提案 B（不推荐） | 提案 C（折中） |
|------|---------------|-----------------|---------------|
| **用户友好性** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |
| **渐进式披露** | ✅ 完全符合 | ❌ 违反原则 | ✅ 符合 |
| **成本优化** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **可维护性** | ⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐ |
| **实施复杂度** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| **长期演进** | ⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 推荐方案：提案 A

### 核心理由

1. **符合渐进式披露原则**：命令层提供用户友好的抽象
2. **成本优化**：智能路由避免过度使用 Agent Teams
3. **质量保证**：混合策略在关键阶段使用 Agent Teams
4. **可维护性**：标准化格式便于长期维护
5. **可扩展性**：新增命令遵循相同模式

### 实施优先级

1. **P0（立即实施）**：
   - 定义约束集、计划、报告的标准格式
   - 更新 `ccg:team-*` 命令，标准化阶段间数据传递

2. **P1（短期实施）**：
   - 在命令层实现智能路由决策逻辑
   - 实现成本预估工具
   - 实现动态降级机制

3. **P2（中期实施）**：
   - 优化所有命令，添加路由元数据
   - 实现阶段状态追踪
   - 更新用户文档和开发者文档

### 成功指标

1. **用户体验**：
   - 用户无需理解 Subagents vs Agent Teams 差异
   - 命令执行前显示成本预估
   - 降级时提供清晰的说明

2. **成本优化**：
   - 简单任务不使用 Agent Teams
   - 复杂任务智能选择模式
   - 平均 Token 成本降低 30%

3. **质量保证**：
   - 混合策略的阶段间数据传递成功率 > 95%
   - 智能路由决策准确率 > 90%
   - 用户满意度 > 85%

---

## 附录：任务规划职责详细分析

### 场景 1：简单查询（如增强 Prompt）

- **任务特征**：无代码变更，单次交互
- **规划者**：主代理
- **执行者**：主代理
- **理由**：任务简单，无需独立上下文

### 场景 2：单模块功能（如添加 API 端点）

- **任务特征**：1-3 个文件，无跨模块依赖
- **规划者**：主代理
- **执行者**：Subagent
- **理由**：规划简单，执行需要独立上下文

### 场景 3：复杂分析（如技术可行性分析）

- **任务特征**：需要多模型视角，无代码变更
- **规划者**：Subagent（调用外部模型）
- **执行者**：主代理（整合分析结果）
- **理由**：分析复杂，需要独立上下文和外部模型

### 场景 4：前后端联调（如 OAuth 集成）

- **任务特征**：4+ 个文件，需要接口对齐
- **规划者**：主代理或 Subagent
- **执行者**：Agent Teams
- **理由**：执行需要实时协商，规划可在 Team 外完成

### 场景 5：多模块重构（如架构升级）

- **任务特征**：10+ 个文件，复杂依赖关系
- **规划者**：混合（侦察 Subagents → 规划 Subagent → 突击 Agent Teams）
- **执行者**：混合
- **理由**：需要分阶段规划和执行，平衡成本与质量

---

## 下一步行动

1. **评审提案**：与团队评审提案 A 的可行性
2. **制定计划**：生成零决策可执行计划
3. **实施 P0 任务**：定义标准格式，更新 `ccg:team-*` 命令
4. **验证效果**：测试阶段间数据传递
5. **迭代优化**：根据反馈优化智能路由逻辑

---

**提案状态**：✅ 完成
**推荐方案**：提案 A - 保留并优化命令层
**下一步**：制定零决策可执行计划
