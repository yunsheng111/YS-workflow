# CCG 架构优化约束集摘要

**生成时间**：2026-02-13
**约束集文件**：C:\Users\Administrator\.claude\.claude\spec\constraints\ccg-architecture-optimization-constraints.md
**提案文件**：C:\Users\Administrator\.claude\.claude\spec\proposals\ccg-architecture-optimization-proposal.md

---

## 核心发现

### 1. 命令层必须保留

**理由**：
- 符合渐进式披露原则，用户无需理解底层 Subagents vs Agent Teams 差异
- 提供工作流封装、降级策略、版本控制能力
- 去除命令层会导致用户认知负担增加（RISK-1：高风险）

**约束支持**：
- SC-1: 渐进式披露原则（软约束）
- SC-3: 命令层存在必要性（软约束）
- HC-6: 用户交互模型（硬约束）

---

### 2. 任务规划职责应动态分配

**推荐策略**：

| 任务类型 | 规划者 | 执行者 | 示例 |
|----------|--------|--------|------|
| 简单任务 | 主代理 | 主代理 | `ccg:enhance` |
| 中等复杂度 | 主代理 | Subagent | `ccg:plan` → `ccg:execute` |
| 高复杂度独立 | Subagent | 主代理 | `ccg:analyze` |
| 高复杂度协作 | 主代理/Subagent | Agent Teams | `ccg:team-plan` → `ccg:team-exec` |

**约束支持**：
- SC-2: 任务规划职责分配（软约束）
- HC-1: 通信拓扑差异（硬约束）
- HC-3: Token 成本差异（硬约束）

---

### 3. 混合策略是成本与质量的最优平衡

**三阶段模型**（已在 CCG 中实践）：

```
侦察（Subagents）→ 突击（Agent Teams）→ 扫尾（Subagents）
   低成本扫描      高协作实施         独立验证
```

**成本对比**：
- 纯 Subagents：1x Token 成本，但无法处理实时协作
- 纯 Agent Teams：7x Token 成本，简单任务浪费严重
- 混合策略：2-3x Token 成本，质量与成本平衡

**约束支持**：
- SC-4: 混合策略优化（软约束）
- HC-3: Token 成本差异（硬约束）
- DEP-4: 混合策略 → 阶段间数据传递（依赖关系）

---

## 关键约束清单

### 硬约束（6 个，必须遵守）

| 编号 | 约束名称 | 核心限制 | 影响 |
|------|----------|----------|------|
| HC-1 | 通信拓扑差异 | Subagents 只能 Hub-and-Spoke，Agent Teams 支持 P2P | 决定何时使用哪种模式 |
| HC-2 | 进程生命周期模型 | Subagents 短生命周期，Agent Teams 长生命周期 | 影响状态管理和资源回收 |
| HC-3 | Token 成本差异 | Agent Teams 约 7x Subagents 成本 | 成本敏感场景必须考虑 |
| HC-4 | 嵌套约束 | 不能嵌套 Subagent 或 Team | 架构必须扁平化 |
| HC-5 | 权限模型差异 | Subagents 可细粒度限缩，Agent Teams 不可 | 高安全场景需考虑 |
| HC-6 | 用户交互模型 | Subagents 透明，Agent Teams 需用户管理 | 影响用户体验设计 |

### 软约束（5 个，强烈推荐）

| 编号 | 约束名称 | 设计原则 | 优化方向 |
|------|----------|----------|----------|
| SC-1 | 渐进式披露原则 | 从简单到复杂逐步暴露能力 | 保留命令层作为抽象 |
| SC-2 | 任务规划职责分配 | 根据复杂度动态分配规划者 | 提供决策矩阵 |
| SC-3 | 命令层存在必要性 | 命令层提供用户友好抽象 | 智能路由 + 成本预估 |
| SC-4 | 混合策略优化 | 在对的阶段用对的工具 | 标准化阶段间数据传递 |
| SC-5 | 可维护性与扩展性 | 职责分离、版本控制 | 提供模板和测试框架 |

### 依赖关系（4 个）

| 编号 | 依赖描述 | 类型 | 缓解措施 |
|------|----------|------|----------|
| DEP-1 | 命令层 → 代理层 | 强依赖 | 定义稳定接口 |
| DEP-2 | 代理层 → MCP 工具/Skills | 强依赖 | 降级策略 |
| DEP-3 | Agent Teams → 共享任务列表 | 强依赖 | 标准任务格式 |
| DEP-4 | 混合策略 → 阶段间数据传递 | 强依赖 | 标准文件格式 |

### 风险（5 个）

| 编号 | 风险描述 | 等级 | 缓解措施 |
|------|----------|------|----------|
| RISK-1 | 去除命令层导致用户认知负担增加 | 高 | 保留命令层 |
| RISK-2 | 任务规划职责不清导致重复工作 | 中 | 明确规划职责矩阵 |
| RISK-3 | Agent Teams 成本失控 | 高 | 成本预估 + 智能路由 |
| RISK-4 | 混合策略阶段间数据传递失败 | 中 | 标准格式 + 验证 |
| RISK-5 | 嵌套约束被违反导致系统崩溃 | 高 | 嵌套检测 + 阻止 |

---

## 量化评估

### Token 成本对比

| 模式 | 成本倍数 | 适用场景 | 示例 |
|------|----------|----------|------|
| 主代理直接执行 | 1x（基准） | 简单任务、无代码变更 | `ccg:enhance` |
| Subagents | 1x | 独立任务、低耦合 | `ccg:plan` |
| Agent Teams | ~7x | 需要实时协作、接口对齐 | `ccg:team-exec` |
| 混合策略 | 2-3x | 复杂任务、分阶段执行 | `ccg:workflow` |

### 用户认知负担评估

| 架构方案 | 认知负担 | 学习曲线 | 用户满意度预期 |
|----------|----------|----------|----------------|
| 保留命令层（提案 A） | 低 | 平缓 | 85%+ |
| 去除命令层（提案 B） | 高 | 陡峭 | 50-60% |
| 混合方案（提案 C） | 中 | 中等 | 70-75% |

### 可维护性评估

| 维度 | 提案 A | 提案 B | 提案 C |
|------|--------|--------|--------|
| 代码组织 | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |
| 版本控制 | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |
| 团队协作 | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐ |
| 扩展性 | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 推荐方案：提案 A

### 核心优化点

1. **命令层智能路由**
   - 根据任务复杂度、协作需求、成本预算自动选择执行方式
   - 执行前显示成本预估
   - 支持动态降级

2. **任务规划职责矩阵**
   - 简单任务：主代理规划并执行
   - 中等复杂度：主代理规划 → Subagents 执行
   - 高复杂度独立：Subagent 规划 → 主代理实施
   - 高复杂度协作：主代理/Subagent 规划 → Agent Teams 执行

3. **混合策略标准化**
   - 定义约束集、计划、报告的标准格式
   - 标准化阶段间数据传递
   - 实现阶段状态追踪

### 实施优先级

**P0（立即实施）**：
- 定义标准格式（约束集、计划、报告）
- 更新 `ccg:team-*` 命令，标准化阶段间数据传递

**P1（短期实施）**：
- 实现命令层智能路由
- 实现成本预估工具
- 实现动态降级机制

**P2（中期实施）**：
- 优化所有命令，添加路由元数据
- 实现阶段状态追踪
- 更新文档

### 成功指标

1. **用户体验**：用户无需理解 Subagents vs Agent Teams 差异
2. **成本优化**：平均 Token 成本降低 30%
3. **质量保证**：阶段间数据传递成功率 > 95%

---

## 关键决策点总结

### 决策 1：命令层是否保留？

**结论**：✅ 必须保留

**理由**：
- 符合渐进式披露原则（SC-1）
- 提供用户友好抽象（HC-6）
- 去除会导致高风险（RISK-1）

---

### 决策 2：任务规划由谁负责？

**结论**：✅ 动态分配

**理由**：
- 不同任务有不同需求（SC-2）
- 需要平衡成本与质量（HC-3）
- 提供决策矩阵指导选择

---

### 决策 3：Subagents vs Agent Teams 如何选择？

**结论**：✅ 根据通信需求和成本预算

**决策树**：
```
是否需要工作者之间互相通信？
  ├─ 否 → Subagents（成本低）
  └─ 是 → 继续评估
      ├─ 是否需要接口契约实时对齐？
      │   └─ 是 → Agent Teams
      ├─ 是否需要多假设并行验证？
      │   └─ 是 → Agent Teams
      └─ 预算是否充足？
          ├─ 是 → Agent Teams
          └─ 否 → Subagents + 主代理协调
```

---

## 文件清单

### 生成的文件

1. **约束集**：`C:\Users\Administrator\.claude\.claude\spec\constraints\ccg-architecture-optimization-constraints.md`
   - 6 个硬约束
   - 5 个软约束
   - 4 个依赖关系
   - 5 个风险

2. **提案**：`C:\Users\Administrator\.claude\.claude\spec\proposals\ccg-architecture-optimization-proposal.md`
   - 提案 A：保留并优化命令层（推荐）
   - 提案 B：去除命令层（不推荐）
   - 提案 C：混合方案（折中）
   - 方案对比和推荐理由

3. **摘要**：`C:\Users\Administrator\.claude\.claude\spec\constraints\ccg-architecture-optimization-summary.md`（本文件）
   - 核心发现
   - 关键约束清单
   - 量化评估
   - 推荐方案

---

## 下一步行动

1. **评审约束集和提案**：与团队评审，确认约束的准确性和提案的可行性
2. **制定零决策计划**：使用 `ccg:spec-plan` 将提案转化为可执行计划
3. **实施 P0 任务**：定义标准格式，更新 `ccg:team-*` 命令
4. **验证效果**：测试阶段间数据传递和智能路由
5. **迭代优化**：根据反馈优化实施方案

---

**约束集状态**：✅ 完成
**提案状态**：✅ 完成
**推荐方案**：提案 A - 保留并优化命令层
**下一步**：评审 → 制定计划 → 实施
