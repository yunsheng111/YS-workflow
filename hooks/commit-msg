#!/usr/bin/env node

/**
 * Git commit-msg Hook
 * 
 * éªŒè¯æäº¤ä¿¡æ¯æ˜¯å¦ç¬¦åˆ Conventional Commits è§„èŒƒ
 * 
 * è§„èŒƒæ ¼å¼ï¼š[emoji] <type>(<scope>): <subject>
 * 
 * ä½¿ç”¨æ–¹å¼ï¼š
 * 1. ç¡®ä¿æ­¤æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™ï¼šchmod +x hooks/commit-msg
 * 2. Git ä¼šåœ¨æäº¤æ—¶è‡ªåŠ¨è°ƒç”¨æ­¤ Hook
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// è¯»å–æäº¤ä¿¡æ¯
const commitMsgFile = process.argv[2];
if (!commitMsgFile) {
  console.error('é”™è¯¯ï¼šæœªæä¾›æäº¤ä¿¡æ¯æ–‡ä»¶è·¯å¾„');
  process.exit(1);
}

const commitMsg = fs.readFileSync(commitMsgFile, 'utf-8').trim();

// è·³è¿‡ç©ºæäº¤ä¿¡æ¯ï¼ˆå¯èƒ½æ˜¯ rebase/mergeï¼‰
if (!commitMsg || commitMsg.startsWith('#')) {
  process.exit(0);
}

// æ£€æµ‹ç©ºæäº¤ï¼ˆæ— æš‚å­˜æ”¹åŠ¨ï¼‰
try {
  const stagedOutput = execSync('git diff --cached --stat', { encoding: 'utf8' }).trim();
  if (!stagedOutput) {
    console.error('\nâŒ æ‹’ç»ç©ºæäº¤ï¼šæ²¡æœ‰æš‚å­˜æ”¹åŠ¨');
    console.error('æç¤ºï¼šè¯·å…ˆä½¿ç”¨ git add æš‚å­˜æ–‡ä»¶ï¼Œæˆ–æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´ã€‚\n');
    process.exit(1);
  }
} catch (err) {
  // æ— æ³•æ£€æµ‹æš‚å­˜çŠ¶æ€ï¼Œè·³è¿‡æ£€æŸ¥
}

// è¯»å–é…ç½®æ–‡ä»¶
let config = null;
const configPath = path.join(process.cwd(), '.ccg', 'commit-config.json');
if (fs.existsSync(configPath)) {
  try {
    config = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
  } catch (err) {
    console.warn('è­¦å‘Šï¼šæ— æ³•è¯»å– .ccg/commit-config.jsonï¼Œä½¿ç”¨é»˜è®¤è§„èŒƒ');
  }
}

// é»˜è®¤é…ç½®
const defaultConfig = {
  format: {
    emoji: true,
    maxSubjectLength: 50,
    requireFooter: true
  },
  types: {
    feat: { emoji: 'âœ¨' },
    fix: { emoji: 'ğŸ›' },
    refactor: { emoji: 'â™»ï¸' },
    docs: { emoji: 'ğŸ“' },
    style: { emoji: 'ğŸ¨' },
    perf: { emoji: 'âš¡' },
    test: { emoji: 'âœ…' },
    chore: { emoji: 'ğŸ”§' },
    ci: { emoji: 'ğŸ‘·' },
    revert: { emoji: 'âª' }
  },
  footer: {
    coAuthor: 'Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>',
    required: true
  }
};

const finalConfig = config || defaultConfig;

// éªŒè¯å‡½æ•°
function validateCommitMessage(message) {
  const errors = [];
  const lines = message.split('\n');
  const firstLine = lines[0];

  // 1. æ£€æŸ¥æ ¼å¼ï¼š[emoji] <type>(<scope>): <subject>
  const formatRegex = /^(\p{Emoji})\s+(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)(\([a-z0-9-]+\))?:\s+.+/u;
  if (!formatRegex.test(firstLine)) {
    errors.push('æ ¼å¼é”™è¯¯ï¼šå¿…é¡»éµå¾ª [emoji] <type>(<scope>): <subject> æ ¼å¼');
    errors.push('ç¤ºä¾‹ï¼šâœ¨ feat(auth): æ·»åŠ  OAuth2.0 ç™»å½•æ”¯æŒ');
    return { valid: false, errors };
  }

  // 2. æå– type å’Œ emoji
  const typeMatch = firstLine.match(/^\p{Emoji}\s+(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)/u);
  const emojiMatch = firstLine.match(/^(\p{Emoji})/u);

  if (typeMatch && emojiMatch) {
    const type = typeMatch[1];
    const emoji = emojiMatch[1];
    const expectedEmoji = finalConfig.types[type]?.emoji;

    // 3. æ£€æŸ¥ emoji æ˜¯å¦åŒ¹é… type
    if (expectedEmoji && emoji !== expectedEmoji) {
      errors.push(`Emoji ä¸åŒ¹é…ï¼š${type} åº”ä½¿ç”¨ ${expectedEmoji}ï¼Œå½“å‰ä½¿ç”¨ ${emoji}`);
    }
  }

  // 4. æ£€æŸ¥ subject é•¿åº¦
  const subjectMatch = firstLine.match(/:\s+(.+)$/);
  if (subjectMatch) {
    const subject = subjectMatch[1];
    const maxLength = finalConfig.format?.maxSubjectLength || 50;
    if (subject.length > maxLength) {
      errors.push(`Subject è¿‡é•¿ï¼š${subject.length} å­—ç¬¦ï¼ˆå»ºè®® â‰¤ ${maxLength}ï¼‰`);
    }
  }

  // 5. æ£€æŸ¥ Co-Authored-By footer
  if (finalConfig.footer?.required) {
    const coAuthor = finalConfig.footer.coAuthor;
    if (!message.includes(coAuthor)) {
      errors.push(`ç¼ºå°‘ Footerï¼š${coAuthor}`);
    }
  }

  return {
    valid: errors.length === 0,
    errors
  };
}

// æ‰§è¡ŒéªŒè¯
const result = validateCommitMessage(commitMsg);

if (!result.valid) {
  console.error('\nâŒ æäº¤ä¿¡æ¯æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ\n');
  console.error('é”™è¯¯è¯¦æƒ…ï¼š');
  result.errors.forEach((err, idx) => {
    console.error(`  ${idx + 1}. ${err}`);
  });
  console.error('\nè¯·ä¿®æ”¹æäº¤ä¿¡æ¯åé‡è¯•ã€‚');
  console.error('å‚è€ƒæ–‡æ¡£ï¼šskills/git-workflow/SKILL.md');
  console.error('é…ç½®æ–‡ä»¶ï¼š.ccg/commit-config.json\n');
  process.exit(1);
}

// éªŒè¯é€šè¿‡
console.log('âœ… æäº¤ä¿¡æ¯æ ¼å¼éªŒè¯é€šè¿‡');
process.exit(0);
